#!/bin/bash
mode=mario
dir=/home/pi/fruitplayer/sfx/
#dir=/usr/share/sounds/fruitplayer/sfx/
count=0
banana=0
rand=$(( ( RANDOM % 25 )  + 15 ))

aplay -q $dir/mario/1up.wav

while :
do

_key()
{
  local kp
  ESC=$'\e'
  _KEY=
  read -d '' -sn1 _KEY
  case $_KEY in
    "$ESC")
        while read -d '' -sn1 -t1 kp
        do
          _KEY=$_KEY$kp
          case $kp in
            [a-zA-NP-Z~]) break;;
          esac
        done
    ;;
  esac
  printf -v "${1:-_KEY}" "%s" "$_KEY"
}

play(){
 aplay -q $dir/$1.wav 
}

pianokeys(){
 for i in a b c d e f 
 	do
	 sleep .05
	  play $i & 
 done
}


_key x

case $x in
  $'w') sound=mario/throw piano=piano/a ; last=w ;;
  $'a') sound=mario/coin piano=piano/b ; last=a ;;
  $'s') sound=mario/fireball ; piano=piano/c ; last=s ;;
  $'d') sound=mario/jump ; piano=piano/d ; last=d ;;
  $'f') sound=mario/kick ; piano=piano/e ; last=f ;;
  $'g') sound=mario/mip ; piano=piano/f ; last=g ;;
  $'\e[A' ) pianokeys ; mode=piano ; last=up ;;
  $'\e[B' ) sound=mario/yoshi ; mode=mario ; last=down ;;
  $'\e[C' ) sound=mario/inventory ; last=right ;;
  $'\e[D' ) sound=mario/inventory ; last=left ;;
  ?) sound=mario/death ; piano=piano/death;;
esac

if [ "$x" = '' ] && [ "$last" = "up" ] ; then
	ip=$(ip addr | grep 'state UP' -A2 |tail -n1 |awk -F 'inet |/' '{print $2}')
        sudo espeak -ven+f3 -k5 -s150 "$ip" 2>/dev/null
	continue
elif [ "$x" = '' ] ; then
	play mario/enter-stage
	shutdown -h now
	exit 0 
fi

if [ $mode = mario ]; then
	if [ $x = s ] ; then
		if [ $banana = $rand ]; then
			play banana &
			banana=0
			rand=$(( ( RANDOM % 25 )  + 15 ))
		else
			play $sound &
			(( banana++ ))
		fi
	else
		play $sound &
	fi
elif [ $mode = piano ]; then
	play $piano &
fi

done
