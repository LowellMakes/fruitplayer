#!/bin/bash
mode=mario
#dir=/usr/share/sounds/fruitplayer/sfx/
sounddir=/home/pi/fruitplayer/sfx
count=0
banana=0
rand=$(( ( RANDOM % 25 )  + 15 ))

aplay -q $sounddir/mario/1up.wav

while :
do

_key()
{
  local kp
  ESC=$'\e'
  _KEY=
  read -d '' -sn1 _KEY
  case $_KEY in
    "$ESC")
        while read -d '' -sn1 -t1 kp
        do
          _KEY=$_KEY$kp
          case $kp in
            [a-zA-NP-Z~]) break;;
          esac
        done
    ;;
  esac
  printf -v "${1:-_KEY}" "%s" "$_KEY"
}

play(){
 aplay -q $dir/$1.wav 
}

pianokeys(){
 dir=$sounddir/piano
 for i in a bb b cc c d e f 
 	do
	 sleep .5
	  play $i & 
 done
}


_key x

case $x in
  $'w') sound=throw piano=a ; last=w ;;
  $'a') sound=coin piano=b ; last=a ;;
  $'s') sound=fireball ; piano=c ; last=s ;;
  $'d') sound=jump ; piano=d ; last=d ;;
  $'f') sound=kick ; piano=e ; last=f ;;
  $'g') sound=mip ; piano=f ; last=g ;;
  $'\e[A' ) mode=piano ; pianokeys ; last=up ;;
  $'\e[B' ) mode=mario ; sound=area_tag ; last=down ;;
  $'\e[C' ) sound=inventory ; last=right ;;
  $'\e[D' ) sound=inventory ; last=left ;;
  ?) sound=death ; piano=death;;
esac

if [ "$x" = '' ] && [ "$last" = "up" ] ; then
	ip=$(ip addr | grep 'state UP' -A2 |tail -n1 |awk -F 'inet |/' '{print $2}')
        sudo espeak -ven+f3 -k5 -s150 "$ip" 2>/dev/null
	continue
elif [ "$x" = '' ] ; then
	play enter-stage
echo "	shutdown -h now"
	exit 0 
fi

if [ $mode = mario ]; then
	dir=$sounddir/mario
	if [ $x = s ] ; then
		if [ $banana = $rand ]; then
			play banana &
			banana=0
			rand=$(( ( RANDOM % 25 )  + 15 ))
		else
			play $sound &
			(( banana++ ))
		fi
	else
		play $sound &
	fi
elif [ $mode = piano ]; then
	dir=$sounddir/piano
	play $piano &
fi

done
